\documentclass[UTF8]{article}
%\documentclass[a4paper,11pt,reqno]{amsart}

\pagestyle{headings}
\usepackage{graphicx}
\usepackage[english]{babel}
\usepackage[T1]{fontenc}
\usepackage[latin1]{inputenc}
\usepackage{verbatim}
\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{amssymb}
\usepackage{amsthm}
\usepackage{pstricks}
\usepackage{mathrsfs}
\usepackage{textcomp}
\usepackage{tikz}
\usepackage{subfig}
\usepackage{fancyvrb}

\usepackage{hyperref}
\hypersetup{
    colorlinks=true,
    linkcolor=blue,
    filecolor=magenta,      
    urlcolor=cyan,
}

\usepackage{csquotes}
\usepackage[backend=biber]{biblatex}
\usepackage{todonotes}

\usepackage{supertabular}
\usepackage{geometry}
\usepackage{ifthen}
\usepackage{alltt}%hack

\include{p4_new_defs}

\addbibresource{p4.bib}
\newtheorem{thm}{Theorem}
\newtheorem{lemma}{Lemma}

\title{%
Pen-and-paper semantics for P4}
\author{Anoud Alshnakat\\
Didrik Lundberg
}
\date{\today}
\begin{document}
\maketitle
\noindent
This is a pen-and-paper semantics of P4, inspired by Core P4~\cite{doenges2021petr4}.

%\newpage
\section{Syntax}
\subsection{Types and Typing Rules}
%
TODO: Base types (integers, booleans, bit strings, errors, headers...), function types (superset of base types also including tables, functions and constructors) and directions (in, out, inout), ...
%
\begin{figure}[h!]
\centering
TODO
\caption{P4 Types}
\end{figure}
%
\begin{figure}[h!]
\centering
TODO
\caption{P4 Typing Rules}
\end{figure}
%
\newpage
\subsection{Expressions}
%
%Let $b$ be a Boolean value and $\mathit{bs} = [b_1 , \ldots , b_n]$ a bitstring. As shown in Figure~\ref{fig:exp}, an expression is either the parser input ($\mathbf{In}$, a bitstring), or the parser output ($\mathbf{Out}$, a map from field names $f$ (strings) to bitstrings - supposed to represent a record), a comparison between two expressions, or a constant bitstring. Note that this means we have currently ignored most unary and binary expressions, keeping only the equality comparison.
%
%Note also that $\mathbf{In}$ and $\mathbf{Out}$ are hard-coded in the sense that they will syntactically be part of the execution state, which is introduced later on. More generally you might have something like just a variable environment, where the variable names $\mathbf{In}$ and $\mathbf{Out}$ map to their respective values.
%
%{\color{red} NOTE: $\mathbf{In}$ and $\mathbf{Out}$ could be renamed with a prefix ``Pars'' or similar, to distinguish them from direction types.}
%
\begin{figure}[h!]
\centering\ottgrammartabular{
\ottexp\ottafterlastrule
}
\caption{P4 Expressions}
\label{fig:exp}
\end{figure}
%
\newpage
\subsection{Statements}
%TODO hyperlinks to P4 specification

%
\begin{figure}[h!]
\centering\ottgrammartabular{
\ottstmt\ottafterlastrule
}
\caption{P4 Statements}
\label{fig:stmt}
\end{figure}

\newpage
\newcommand{\state}{\textit{state}}
\subsection{Execution State}
The execution state \state{} holds an environment stack $\textit{env\_stack}$, a stack of environment stacks $\textit{temp\_stack}$ and the execution status $\textit{status}$. Note that the execution state is not in the P4 specification, but rather made up by yours truly.

\textbf{Running} represents that the parser is executing under regular circumstances. \textbf{TypeError} represents a crash caused by some badly-typed part of the program.

\begin{figure}[h!]
\centering\ottgrammartabular{
\ottstatus\ottinterrule
\ottstate\ottafterlastrule
}
\caption{P4 Execution State}
\label{fig:status}
\end{figure}

\section{Semantics}
\subsection{Expressions}
%\begin{figure}[h!]
%\centering\ottgrammartabular{
%\ottexpXXsem\ottafterlastrule
%}
%\caption{Judgment Forms of P4 Expression Evaluation}
%\label{fig:judgexp}
%\end{figure}
The \href{https://p4.org/p4-spec/docs/P4-16-v1.2.1.html#sec-exprs}{full set of P4 expressions} as stated by the P4 specification includes a lot more than the expressions stated here. Currently, the string value is not included in our syntax. Additional unary and binary expressions and predicates should be easy to add.

\begin{figure}[h!]
\centering\ottdefnsexpXXsem
\caption{P4 Expression Evaluation Semantics}
\label{fig:semexp}
\end{figure}

\href{https://p4.org/p4-spec/docs/P4-16-v1.2.1.html#sec-expr-eval-order}{Section 8.1} of the P4 specification states that expressions are evaluated left-to-right. Accordingly, our rules are split up so that (small-step) reduction of the second operand requires that the first operand has been completely reduced.

In the \textsc{Lookup} rule, $\mathit{env\_stack}(\mathit{var\_name})$ tries to look up the variable name in the current scope at the top of the stack, then successively tries superscopes all the way to the global scope at the bottom of the stack. This agrees with the description in Sections 6.8 and 10.2 in the P4 specification.

\newpage
\subsection{Statement Execution}
%\begin{figure}[h!]
%\centering\ottgrammartabular{
%\ottpFourXXparserXXbstmtXXred\ottinterrule
%\ottpFourXXparserXXblockXXred\ottinterrule
%\ottpFourXXparserXXnblockXXred\ottafterlastrule
%}
%\caption{Judgment Forms of P4 Statement Execution}
%\label{fig:judgexec}
%\end{figure}

\begin{figure}[h!]
\ottdefnsstmtXXsem
\caption{P4 Statement Execution Semantics}
\label{fig:semstmtexec}
\end{figure}

\begin{figure}[h!]
\ottdefnsstmtXXsemXXfin
\caption{P4 Statement Finalizing Execution Semantics}
\label{fig:semfinstmtexec}
\end{figure}

%\begin{figure}[h!]
%\ottdefnspFourXXparserXXstrXXstmtXXred
%\caption{P4 Structural Statement Execution Semantics}
%\label{fig:semstmtexec}
%\end{figure}
%
%\begin{figure}[h!]
%\ottdefnspFourXXparserXXblockXXred
%\caption{P4 Parser State Execution Semantics}
%\label{fig:semblockexec}
%\end{figure}
%
%\begin{figure}[h!]
%\ottdefnspFourXXparserXXnblockXXred
%\caption{P4 $n$-Parser State Execution Semantics}
%\label{fig:semnblockexec}
%\end{figure}

\printbibliography
\end{document}

